<!doctype html>
<head>
	<title>{{nome}} - profilo</title>
	{%include 'links.html'%}
	<script src="{{ url_for('static',filename='js/dropzone.js')}}"></script>
	<link href="{{ url_for('static',filename='css/dropzone.css')}}" rel="stylesheet" type="text/css">
	<script>
		$(document).ready(function() {
			$('select').material_select();
			$('.button-collapse').sideNav();
			$('#dropnav').dropdown({ hover: true, belowOrigin: false });
			$('#dropbar').dropdown({ hover: false, belowOrigin: false });
		});
	</script>
</head>
<body>
	{%include 'navbar_sidebar.html'%}
	<div class="container">
        <!-- Page Content goes here -->
		<div class="row">
			<div id="user-title" class="col s12">
				<h5 class="grey-darken-3 white-text" >
				Gestisci il tuo account 
			</h5>
			</div>
			<div class="col s12 m4 l3">
				<div class="card center-align">
					<div class="card-content white-text center-align">
						<img class="responsive-img center-align circle" id="userpage-img" src="/images/{{nome}}.jpg">
						<div class="row">
						<div class="col s8 m12 offset-s2 ">
							<div class="collection grey-darken-3">
					            <a href="/logout" class="btn-flat waves-effect waves-dark  lighten-5 collection-item"><i class="material-icons">exit_to_app</i> Esci</a>
					            <a class="collection-item" href="#cambia-avatar">Cambia avatar</a>
					            <a class="collection-item" href="#cambia-pwd">Cambia password</a>
					        </div>
				        </div>
				        </div>&#160
					</div>
				</div>
			</div>
				<div class="col s12 m8 l9">
			{%if group==None%}
			<div class="card">
				<span class="card-title">Novità !</span>
					<div class="card-content white-text">
					<p class="flow-text">Sono stati aggiunti i gruppi, ora tu e i tuoi coinquilini farete parte dello stesso gruppo. Tuttavia risulta che tu non sia assegnato a nessun gruppo, non c'è problema: scegline uno dalla lista o creane uno nuovo</p>
					{%if guppi%}
					<form action="#">
						{%for gruppo in gruppi%}
					    <p>
					      <input name="group1" type="radio" id="test1" />
					      <label for="test1">Red</label>
					    </p>
					    {%endfor%}
					  </form>
					  {%endif%}
					</div>
				</div>
				{%endif%}
				<div class="card small" id="cambia-avatar">
					<div class="card-content">
					<span class="card-title white-text">Cambia avatar</span>
					<div class="row">
						<div class="col s12 center-align">
						<form class="dropzone" id="my-awesome-dropzone" method="POST" action="/change-avatar" enctype="multipart/form-data">
						<script type="text/javascript">

							Dropzone.options.myAwesomeDropzone = {
								  method:"POST",
								  paramName: "file", // The name that will be used to transfer the file
								  maxFilesize: 3,
								  parallelUploads: 1,
								  uploadMultiple: false,
								  maxFiles:1,
								  acceptedFiles: "image/jpeg,image/png,image/gif",
								  addRemoveLinks: false,
								  dictResponseError: 'Errore, controlla che il file rispetti i limiti!',
								  dictFileTooBig:'File troppo grande o dimensioni errate',
								  dictMaxFilesExceeded:'Ricarica la pagina per cambiare di nuovo avatar',
								  accept: function(file, done) {
									    file.acceptDimensions = done;
									    file.rejectDimensions = function() { done("il file ha una dimensione troppo grande"); };
									    // Of course you could also just put the `done` function in the file
									    // and call it either with or without error in the `thumbnail` event
									    // callback, but I think that this is cleaner.
									  },

								  init: function() {
								  	 this.on("error", function(file,errormessage, xhr){
								  	 	if (!file.accepted) {
								  	 		setTimeout(function(){
												this.removeFile(file);
											}, 2000);
								  	 		}
								  	 	});
								  	 this.on("success", function(file,errormessage, xhr){
										Materialize.toast('Avatar cambiato con successo', 2500,'green',
											//function(){location.reload()}
											)
								  	 });
								  	 this.on("thumbnail", function(file) {
     										// Do the dimension checks you want to do
								      if (file.width > 800 || file.height > 800) {
								        file.rejectDimensions()
								      }
								      else {
								        file.acceptDimensions();
								      }
								    });
								  }
							}
							
						</script>
						<div class="dz-message" data-dz-message><span><b>Clicca qui</b>  o trascina un immagine per selezionare il nuovo avatar</span>
						<span style="font-size: 70%;"><br>È consigliata un'immagine quadrata. Massimo 650x650px che non superi i 3MB</span></div>
							<div class="fallback">
							    <input name="file" type="file" multiple />
							</div>
						</form>
						</div>
						</div>
						</div>
					</div>
				<div class="card grey-darken-3 white-text" id="cambia-pwd">
				<div class="card-content">
				<span class="card-title">Cambia password</span>
				<form id="change-pwd-form" name="change-pwd-form" action="">
				<div class="container">
					<div class="row">
						<div class="input-field col s12">
							<input id="old_password" type="password" required class="validate">
							<label for="old_password">Password attuale</label>
						</div>
						<div class="input-field col s12 l6 suffix">
							<i class="material-icons tiny" id="visibility1" onmouseup="hidepwd(this.id)" ontouchstart="showpwd(this.id)" ontouchend="hidepwd(this.id)" onmousedown="showpwd(this.id)">visibility</i>
				          <input id="new_password" type="password" required class="validate" required>
				          <label for="new_password">Nuova password</label>
				        </div>
				        <div class="input-field col s12 l6 suffix">
				        <i class="material-icons tiny" id="visibility2" onmouseup="hidepwd(this.id)" onmousedown="showpwd(this.id)" ontouchstart="showpwd(this.id)" ontouchend="hidepwd(this.id)">visibility</i>
				          <input id = "new_password2" type="password" class="validate" required oninput="validatepassword()">
				          <label for="new_password2">Conferma password</label>
				        </div>
				        <button class="btn waves-effect waves-light" type="submit" name="action" id="change-pwd-send">Conferma
						    <i class="material-icons right" >send</i>
						</button>
					</div></div>
				</form>
				<script type="text/javascript">
					function validatepassword() {
					    var x = document.forms["change-pwd-form"]["new_password"].value;
					    var y = document.forms["change-pwd-form"]["new_password2"].value;
					    if (x != y) {
					        $('#new_password2').addClass('invalid');
					        $('#new_password2').removeClass('valid');
					    }
					    else{
					    	$('#new_password2').addClass('valid');
					        $('#new_password2').removeClass('invalid');
					    }
					}


					$('#change-pwd-form').submit( function(event) {
						event.preventDefault();

						url= "/changepwd";
						var posting = $.post( url, { old_password: $('#old_password').val(), new_password: $('#new_password').val() },
							function( data ) {
							  if (data['result']==true){
							  	Materialize.toast("Password cambiata con successo", 2200,"green");
							  	document.getElementById("change-pwd-form").reset();
							  	window.location.replace("/user#cambia-pwd")
							  }
							  else {
							  	Materialize.toast("c'è stato  un errore controlla di aver inserito la password corretta", 2200,"red");
							  }
							}
							);
						
						});

					function showpwd(obj) {
					  if(obj=="visibility1"){
					  	var field = document.getElementById("new_password");
					  	field.type = "text";
					  }
					  else{
						var field = document.getElementById("new_password2");
					  	field.type = "text";  	
					  }
					}

					function hidepwd(obj) {
					  if(obj=="visibility1"){
					  	var field = document.getElementById("new_password");
					  	field.type = "password";
					  }
					  else{
						var field = document.getElementById("new_password2");
					  	field.type = "password";  	
					  }
					}

				</script>
				</div>
				</div>	
			</div>
        </div>
    </div>

</body>
